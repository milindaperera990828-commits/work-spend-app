<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Work &amp; Spend v1.2 — Milinda &amp; Sewmini</title>
  <meta name="theme-color" content="#0b0c10">
  <style>
    :root{
      --bg:#0b0c10; --panel:#12141a; --muted:#c7c9d1; --text:#f7f8fb;
      --accent:#2dd4bf; --accent-2:#60a5fa; --danger:#ef4444; --ok:#22c55e; --warn:#f59e0b;
      --border:#1f2430; --chip:#1a1f2b; --shadow:0 8px 20px rgba(0,0,0,.35); --radius:14px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:#0e1017;color:var(--text);font:16px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;}
    header{position:sticky;top:0;z-index:10;background:rgba(11,12,16,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:6px 0 2px} .sub{color:var(--muted);font-size:13px}
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    nav button{appearance:none;border:1px solid var(--border);background:var(--chip);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:600}
    nav button.active{border-color:var(--accent);box-shadow:inset 0 0 0 1px var(--accent)}
    main{padding:18px 16px 60px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.row > *{flex:1}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0f1320;color:var(--text);outline:none}
    input[type="date"], input[type="month"], input[type="number"]{font-variant-numeric:tabular-nums}
    textarea{min-height:80px;resize:vertical}
    .btn{appearance:none;border:none;padding:12px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#0b0c10}.btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .btn.danger{background:var(--danger);color:#fff}.btn.warn{background:var(--warn);color:#0b0c10}
    .section-title{margin:0 0 10px 2px;font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em}
    .num{font-variant-numeric:tabular-nums}.pill{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:12px}
    .hide{display:none}.right{margin-left:auto}.small{font-size:12px}.muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse;font-size:14px} th,td{border-bottom:1px solid var(--border);padding:10px 8px;vertical-align:top} th{text-align:left;color:var(--muted);font-weight:600}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div>
          <h1>Work &amp; Spend — v1.2</h1>
          <div class="sub">Two people (Milinda &amp; Sewmini). Sites with default hours. Persistent storage (IndexedDB).</div>
        </div>
        <div class="right">
          <label class="small">Month</label>
          <input type="month" id="monthPicker">
        </div>
      </div>
      <nav id="tabs">
        <button data-tab="dashboard" class="active">Dashboard</button>
        <button data-tab="income">Income</button>
        <button data-tab="sites">Sites</button>
        <button data-tab="reports">Reports</button>
        <button data-tab="backup">Export / Import</button>
        <button data-tab="settings">Settings</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <!-- DASHBOARD -->
    <section id="dashboard" class="tab">
      <div class="grid">
        <div class="card">
          <div class="section-title">Income (This Month)</div>
          <div class="row">
            <div><label>Total</label><div id="kpiIncome" class="num" style="font-size:26px;font-weight:800">$0.00</div></div>
            <div><label>Milinda</label><div id="kpiMilinda" class="num">$0.00</div></div>
            <div><label>Sewmini</label><div id="kpiSewmini" class="num">$0.00</div></div>
          </div>
          <div class="small muted" id="incomeHoursHint"></div>
        </div>
        <div class="card">
          <div class="section-title">Recent Shifts</div>
          <table id="recentTable">
            <thead><tr><th>Date</th><th>Person</th><th>Site</th><th class="num">Hours</th><th class="num">Rate</th><th class="num">Pay</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- INCOME -->
    <section id="income" class="tab hide">
      <div class="grid">
        <div class="card">
          <div class="section-title">Add Income</div>
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="incDate" autofocus>
            </div>
            <div>
              <label>Person</label>
              <select id="incPerson">
                <option value="Milinda">Milinda</option>
                <option value="Sewmini">Sewmini</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Site</label>
              <select id="incSite"></select>
            </div>
            <div>
              <label>Hours (auto from site day)</label>
              <input type="number" id="incHours" step="0.01" min="0">
            </div>
            <div>
              <label>Hourly Rate (AUD)</label>
              <input type="number" id="incRate" step="0.01" min="0" placeholder="e.g., 23.50">
            </div>
          </div>
          <div>
            <label>Notes (optional)</label>
            <textarea id="incNotes" placeholder="Shift notes"></textarea>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="addIncomeBtn">Add Income</button>
            <div class="right pill">Change hours/rate if different from default.</div>
          </div>
        </div>

        <div class="card">
          <div class="section-title">Income This Month</div>
          <table id="incomeTable">
            <thead><tr><th>Date</th><th>Person</th><th>Site</th><th class="num">Hours</th><th class="num">Rate</th><th class="num">Pay</th><th>Notes</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SITES -->
    <section id="sites" class="tab hide">
      <div class="grid">
        <div class="card">
          <div class="section-title">Add / Edit Site</div>
          <div class="row">
            <div><label>Site Name</label><input id="siteName" placeholder="e.g., Realm Apartment"></div>
            <div><label>Default Hourly Rate (optional)</label><input id="siteRate" type="number" step="0.01" placeholder="e.g., 23.50"></div>
          </div>
          <div class="row">
            <div><label>Mon</label><input id="hMon" type="number" step="0.01"></div>
            <div><label>Tue</label><input id="hTue" type="number" step="0.01"></div>
            <div><label>Wed</label><input id="hWed" type="number" step="0.01"></div>
            <div><label>Thu</label><input id="hThu" type="number" step="0.01"></div>
          </div>
          <div class="row">
            <div><label>Fri</label><input id="hFri" type="number" step="0.01"></div>
            <div><label>Sat</label><input id="hSat" type="number" step="0.01"></div>
            <div><label>Sun</label><input id="hSun" type="number" step="0.01"></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="saveSiteBtn">Save Site</button>
            <button class="btn ghost" id="resetSiteForm">Reset</button>
          </div>
        </div>

        <div class="card">
          <div class="section-title">Your Sites</div>
          <table id="sitesTable">
            <thead><tr><th>Site</th><th class="num">Mon–Sun hours</th><th class="num">Rate</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="tab hide">
      <div class="grid">
        <div class="card">
          <div class="section-title">Earnings by Site (This Month)</div>
          <table id="bySiteTable">
            <thead><tr><th>Site</th><th class="num">Milinda</th><th class="num">Sewmini</th><th class="num">Total</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <div class="section-title">Monthly Income by Person</div>
          <table id="byPersonTable">
            <thead><tr><th>Person</th><th class="num">Income</th><th class="num">Hours</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="backup" class="tab hide">
      <div class="grid">
        <div class="card">
          <div class="section-title">Backup &amp; Restore</div>
          <div class="row">
            <button class="btn primary" id="exportBtn">Export JSON</button>
            <input type="file" id="importJson" accept=".json">
            <button class="btn danger right" id="wipeBtn">Wipe All Data</button>
          </div>
          <div class="small muted">Data is stored in <strong>IndexedDB</strong> (persistent). Export regularly as a safety backup.</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="tab hide">
      <div class="grid">
        <div class="card">
          <div class="section-title">Currency</div>
          <div class="row">
            <input type="text" id="currencySymbol" value="$">
            <div class="pill">Use "$" for AUD.</div>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
// ====== Tiny IndexedDB helper ======
const dbName = 'ws_db_v2';
const dbVersion = 1;
let db;

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(dbName, dbVersion);
    req.onupgradeneeded = (e)=>{
      const d = e.target.result;
      d.createObjectStore('settings', {keyPath:'id'});
      d.createObjectStore('sites', {keyPath:'id'});
      d.createObjectStore('income', {keyPath:'id'});
    };
    req.onsuccess = ()=>{ db = req.result; resolve(db); };
    req.onerror = ()=> reject(req.error);
  });
}

function tx(store, mode='readonly'){
  return db.transaction(store, mode).objectStore(store);
}
function getAll(store){ return new Promise((res,rej)=>{ const r = tx(store).getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>rej(r.error); }); }
function put(store, val){ return new Promise((res,rej)=>{ const r = tx(store,'readwrite').put(val); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }
function del(store, key){ return new Promise((res,rej)=>{ const r = tx(store,'readwrite').delete(key); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }
function clear(store){ return new Promise((res,rej)=>{ const r = tx(store,'readwrite').clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }); }

// ====== App State (from DB) ======
let SETTINGS = { id:'settings', currencySymbol:'$', people:['Milinda','Sewmini'] };
let SITES = []; // {id,name,rate,h:[mon..sun]}
let INCOME = []; // {id,date,person,siteId,hours,rate,notes}

const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const fmt = (n, sym)=> (sym||'$') + (Number(n||0).toFixed(2));
const todayISO = ()=> new Date().toISOString().slice(0,10);
const monthKey = (d)=> (d||todayISO()).slice(0,7);
const dayIdx = (iso)=> new Date(iso).getDay(); // 0=Sun..6=Sat

async function init(){
  await openDB();
  // settings
  const s = await tx('settings').get('settings');
  if(s && s.result){ SETTINGS = s.result; }
  else {
    await put('settings', SETTINGS);
  }
  // sites
  SITES = await getAll('sites');
  if(SITES.length===0){
    // Seed with your current sites
    const seedNames = [
      "Netball Stadium SA (Priceline)",
      "Realm Apartment",
      "Randle and Tyler",
      "Heidelberg cakes",
      "Team Global Express (Covering Sift)",
      "Modbury Jets Amateur Football Club"
    ];
    for(const name of seedNames){
      await addOrUpdateSite({id:uid(), name, rate: null, h:[0,0,0,0,0,0,0]});
    }
    SITES = await getAll('sites');
  }
  // income
  INCOME = await getAll('income');

  // UI
  $("#monthPicker").value = monthKey(todayISO());
  $("#currencySymbol").value = SETTINGS.currencySymbol;
  refreshAll();

  // Events
  $("#tabs").addEventListener('click', (e)=>{
    if(e.target.tagName!=='BUTTON') return;
    $$('#tabs button').forEach(b=>b.classList.remove('active'));
    e.target.classList.add('active');
    $$('.tab').forEach(t=>t.classList.add('hide'));
    $('#'+e.target.dataset.tab).classList.remove('hide');
  });

  $("#currencySymbol").addEventListener('input', async ()=>{
    SETTINGS.currencySymbol = $("#currencySymbol").value || '$';
    await put('settings', SETTINGS);
    refreshAll();
  });

  // Income form
  $("#incDate").value = todayISO();
  buildSiteOptions();
  $("#incSite").addEventListener('change', siteHoursFill);
  $("#incDate").addEventListener('change', siteHoursFill);
  $("#addIncomeBtn").addEventListener('click', addIncome);
  // Sites
  $("#saveSiteBtn").addEventListener('click', saveSiteFromForm);
  $("#resetSiteForm").addEventListener('click', resetSiteForm);

  // Backup
  $("#exportBtn").addEventListener('click', exportJSON);
  $("#importJson").addEventListener('change', importJSON);
  $("#wipeBtn").addEventListener('click', wipeAll);
}

function uid(){ return Math.random().toString(36).slice(2,10); }

async function addOrUpdateSite(site){
  await put('sites', site);
}

function buildSiteOptions(){
  const sel = $("#incSite");
  sel.innerHTML = '';
  SITES.sort((a,b)=> a.name.localeCompare(b.name)).forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s.id; opt.textContent = s.name;
    sel.appendChild(opt);
  });
}

function siteHoursFill(){
  const siteId = $("#incSite").value;
  const d = $("#incDate").value || todayISO();
  const s = SITES.find(x=>x.id===siteId);
  if(!s) return;
  const idx = dayIdx(d); // 0 Sun..6 Sat
  const mondayFirstIndex = idx===0?6:idx-1; // convert to our [Mon..Sun] index
  $("#incHours").value = Number(s.h[mondayFirstIndex]||0);
  if(s.rate!=null && s.rate!==''){ $("#incRate").value = s.rate; }
}

async function addIncome(){
  const item = {
    id: uid(),
    date: $("#incDate").value || todayISO(),
    person: $("#incPerson").value,
    siteId: $("#incSite").value,
    hours: parseFloat($("#incHours").value||0),
    rate: parseFloat($("#incRate").value||0),
    notes: ($("#incNotes").value||'').trim()
  };
  if(!item.hours || !item.rate){ alert('Enter hours and rate'); return; }
  await put('income', item);
  INCOME = await getAll('income');
  $("#incHours").value=''; $("#incRate").value=''; $("#incNotes").value='';
  renderIncomeTable();
  renderDashboard();
  renderReports();
}

function siteById(id){ return SITES.find(s=>s.id===id) || {name:'(deleted site)'}; }

function renderIncomeTable(){
  const m = $("#monthPicker").value;
  const tbody = $("#incomeTable tbody"); tbody.innerHTML='';
  INCOME.filter(i=>i.date.startsWith(m)).sort((a,b)=> a.date<b.date?1:-1).forEach(i=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i.date}</td>
      <td>${i.person}</td>
      <td>${escapeHtml(siteById(i.siteId).name)}</td>
      <td class="num">${i.hours.toFixed(2)}</td>
      <td class="num">${fmt(i.rate, SETTINGS.currencySymbol)}</td>
      <td class="num">${fmt(i.hours*i.rate, SETTINGS.currencySymbol)}</td>
      <td>${escapeHtml(i.notes||'')}</td>
      <td><button class="btn danger small" data-id="${i.id}" data-act="del">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
  tbody.onclick = async (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    if(b.dataset.act==='del'){
      await del('income', b.dataset.id);
      INCOME = await getAll('income');
      renderIncomeTable(); renderDashboard(); renderReports();
    }
  };
}

function renderDashboard(){
  const m = $("#monthPicker").value;
  const rows = INCOME.filter(i=>i.date.startsWith(m));
  const sum = rows.reduce((s,i)=> s + i.hours*i.rate, 0);
  const sumM = rows.filter(i=>i.person==='Milinda').reduce((s,i)=> s + i.hours*i.rate, 0);
  const sumS = rows.filter(i=>i.person==='Sewmini').reduce((s,i)=> s + i.hours*i.rate, 0);
  $("#kpiIncome").textContent = fmt(sum, SETTINGS.currencySymbol);
  $("#kpiMilinda").textContent = fmt(sumM, SETTINGS.currencySymbol);
  $("#kpiSewmini").textContent = fmt(sumS, SETTINGS.currencySymbol);
  const hrs = rows.reduce((s,i)=> s + i.hours, 0);
  $("#incomeHoursHint").textContent = `${hrs.toFixed(2)} hours across ${rows.length} shifts`;

  const rec = rows.slice().sort((a,b)=> a.date<b.date?1:-1).slice(0,8);
  const rt = $("#recentTable tbody"); rt.innerHTML='';
  rec.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.person}</td><td>${escapeHtml(siteById(r.siteId).name)}</td>
      <td class="num">${r.hours.toFixed(2)}</td><td class="num">${fmt(r.rate, SETTINGS.currencySymbol)}</td><td class="num">${fmt(r.hours*r.rate, SETTINGS.currencySymbol)}</td>`;
    rt.appendChild(tr);
  });
}

function renderReports(){
  const m = $("#monthPicker").value;
  const rows = INCOME.filter(i=>i.date.startsWith(m));
  // By site
  const map = {};
  for(const i of rows){
    const site = siteById(i.siteId).name;
    map[site] = map[site] || {Milinda:0,Sewmini:0};
    map[site][i.person] += i.hours*i.rate;
  }
  const tbody = $("#bySiteTable tbody"); tbody.innerHTML='';
  Object.entries(map).sort((a,b)=> (b[1].Milinda+b[1].Sewmini) - (a[1].Milinda+a[1].Sewmini))
    .forEach(([site,vals])=>{
      const total = vals.Milinda + vals.Sewmini;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(site)}</td>
        <td class="num">${fmt(vals.Milinda, SETTINGS.currencySymbol)}</td>
        <td class="num">${fmt(vals.Sewmini, SETTINGS.currencySymbol)}</td>
        <td class="num">${fmt(total, SETTINGS.currencySymbol)}</td>`;
      tbody.appendChild(tr);
    });
  // By person
  const pm = rows.filter(i=>i.person==='Milinda');
  const ps = rows.filter(i=>i.person==='Sewmini');
  const tbody2 = $("#byPersonTable tbody"); tbody2.innerHTML='';
  const addRow = (name,list)=>{
    const income = list.reduce((s,i)=> s + i.hours*i.rate, 0);
    const hours = list.reduce((s,i)=> s + i.hours, 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name}</td><td class="num">${fmt(income, SETTINGS.currencySymbol)}</td><td class="num">${hours.toFixed(2)}</td>`;
    tbody2.appendChild(tr);
  };
  addRow('Milinda', pm);
  addRow('Sewmini', ps);
}

// Sites UI
function resetSiteForm(){
  $("#siteName").value=''; $("#siteRate").value='';
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=> $("#h"+d).value='');
}
async function saveSiteFromForm(){
  const name = ($("#siteName").value||'').trim();
  if(!name){ alert('Enter site name'); return; }
  const h = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(d=> parseFloat($("#h"+d).value||0));
  const rate = parseFloat($("#siteRate").value||''); const site = {id:uid(), name, rate: isNaN(rate)? null: rate, h};
  await addOrUpdateSite(site);
  SITES = await getAll('sites');
  buildSiteOptions(); renderSitesTable();
  resetSiteForm();
}

function renderSitesTable(){
  const tbody = $("#sitesTable tbody"); tbody.innerHTML='';
  SITES.sort((a,b)=> a.name.localeCompare(b.name)).forEach(s=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(s.name)}</td>
      <td class="num">${s.h.map(x=>Number(x||0).toFixed(2)).join(' / ')}</td>
      <td class="num">${s.rate!=null? fmt(s.rate, SETTINGS.currencySymbol): '—'}</td>
      <td><button class="btn danger small" data-id="${s.id}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.onclick = async (e)=>{
    const b = e.target.closest('button'); if(!b) return;
    const id = b.dataset.id;
    if(confirm('Delete this site? (existing income rows keep their reference)')){
      await del('sites', id);
      SITES = await getAll('sites'); buildSiteOptions(); renderSitesTable();
    }
  };
}

// Backup
async function exportJSON(){
  const data = {
    settings: SETTINGS,
    sites: await getAll('sites'),
    income: await getAll('income')
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `work_spend_backup_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(a.href);
}
async function importJSON(e){
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  try{
    const data = JSON.parse(text);
    if(!data.income || !data.sites || !data.settings) throw new Error('Invalid backup');
    await clear('income'); await clear('sites'); await clear('settings');
    await put('settings', data.settings);
    for(const s of data.sites) await put('sites', s);
    for(const i of data.income) await put('income', i);
    SETTINGS = data.settings; SITES = data.sites; INCOME = data.income;
    $("#currencySymbol").value = SETTINGS.currencySymbol;
    buildSiteOptions(); refreshAll();
    alert('Imported successfully');
  }catch(err){ alert('Import failed: '+err.message); }
}
async function wipeAll(){
  if(!confirm('Wipe ALL data?')) return;
  await clear('income'); await clear('sites'); await clear('settings');
  location.reload();
}

// Helpers
function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
function refreshAll(){
  renderIncomeTable();
  renderDashboard();
  renderSitesTable();
  renderReports();
}

// Month change
$("#monthPicker")?.addEventListener('change', ()=>{ renderIncomeTable(); renderDashboard(); renderReports(); });

// Start
init();
</script>
</body>
</html>
